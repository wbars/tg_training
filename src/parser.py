import json
from dataclasses import dataclass
from typing import Optional
from anthropic import AsyncAnthropic


@dataclass
class ParsedExercise:
    exercise: str  # Normalized canonical name
    exercise_raw: str  # What user actually said
    weight: Optional[float]  # kg
    reps: Optional[int]
    comment: Optional[str]


SYSTEM_PROMPT = """Ты - парсер для приложения логирования тренировок в зале. Твоя задача - извлечь из свободной речи на русском языке структурированную информацию о выполненном упражнении.

ВАЖНО: Ты должен вернуть JSON и НИЧЕГО БОЛЬШЕ. Никакого текста до или после JSON.

## Формат ответа (строго JSON):
{
    "exercise": "Нормализованное название упражнения",
    "exercise_raw": "Как пользователь назвал упражнение",
    "weight": 60.0,
    "reps": 8,
    "comment": "комментарий или null"
}

## Правила парсинга:

### Вес:
- "60 кг", "60кг", "60 килограмм" → 60.0
- "на 60", "с 60" (в контексте) → 60.0
- "пустой гриф", "гриф" → 20.0
- "с блинами по 10" → требуется контекст, если непонятно → null
- "собственный вес", "своим весом", "без веса" → null (оставить null, не 0)

### Повторения:
- "на 8", "8 раз", "8 повторений", "восемь" → 8
- "на 5 раз", "по 5" → 5
- "до отказа" → null + добавить в комментарий

### Комментарий:
- Всё что не относится к упражнению/весу/повторам
- Ощущения: "тяжело", "легко", "болит колено"
- Заметки: "широкий хват", "с паузой", "в отказ"

## НОРМАЛИЗАЦИЯ УПРАЖНЕНИЙ (КРИТИЧЕСКИ ВАЖНО):

Всегда приводи к каноническому названию из списка ниже. Если упражнения нет в списке - используй наиболее понятное русское название.

### Ноги - Приседания:
"присед", "приседания", "присяд", "приседы", "скват", "squat", "сквот", "приседание" → "Присед"
"присед со штангой", "приседания со штангой" → "Присед со штангой"
"фронтальный присед", "фронталки", "фронтальные приседания" → "Фронтальный присед"
"гоблет присед", "гоблет", "кубковые приседания", "goblet" → "Гоблет присед"
"присед в смите", "смит присед", "приседания в смите" → "Присед в Смите"
"гакк присед", "гакк", "гак присед", "hack squat" → "Гакк-присед"
"болгарские выпады", "болгарский сплит присед", "сплит присед" → "Болгарский сплит-присед"

### Ноги - Другое:
"выпады", "ланжи", "lunges", "выпад" → "Выпады"
"жим ногами", "жим платформы", "leg press", "легпресс" → "Жим ногами"
"разгибания ног", "разгибание ног", "leg extension", "экстензия ног", "квадрицепс в тренажере" → "Разгибания ног"
"сгибания ног", "сгибание ног", "leg curl", "бицепс бедра", "сгибания бицепса бедра" → "Сгибания ног"
"икры", "подъем на носки", "подъём на носки", "голень", "calf raise", "икроножные" → "Подъём на носки"
"мертвая тяга", "мёртвая тяга", "румынская тяга", "румынка", "рдл", "rdl" → "Румынская тяга"

### Спина - Тяги:
"становая", "становая тяга", "станина", "deadlift", "дедлифт", "тяга становая" → "Становая тяга"
"становая сумо", "сумо тяга", "сумо" → "Становая тяга сумо"
"тяга в наклоне", "тяга штанги в наклоне", "тяга штанги", "barbell row", "тяга к поясу" → "Тяга штанги в наклоне"
"тяга гантели", "тяга гантели в наклоне", "тяга гантели к поясу", "тяга одной рукой" → "Тяга гантели в наклоне"
"тяга т грифа", "т гриф", "т-гриф", "тяга т-грифа", "t-bar row" → "Тяга Т-грифа"

### Спина - Вертикальные тяги:
"подтягивания", "подтяги", "турник", "pull-ups", "pullups", "пулапы" → "Подтягивания"
"подтягивания широким хватом", "широкие подтягивания" → "Подтягивания широким хватом"
"подтягивания узким хватом", "узкие подтягивания" → "Подтягивания узким хватом"
"подтягивания обратным хватом", "обратные подтягивания", "chin-ups", "чинапы" → "Подтягивания обратным хватом"
"тяга верхнего блока", "верхняя тяга", "тяга сверху", "вертикальная тяга", "lat pulldown", "тяга к груди" → "Тяга верхнего блока"
"тяга горизонтального блока", "горизонтальная тяга", "гребля", "тяга блока к поясу", "cable row" → "Тяга горизонтального блока"

### Спина - Другое:
"гиперэкстензия", "гиперы", "гипер", "hyperextension", "экстензия", "разгибания спины" → "Гиперэкстензия"
"шраги", "шраги со штангой", "шраги с гантелями", "трапеция", "shrugs" → "Шраги"
"пуловер", "pullover", "пулловер" → "Пуловер"

### Грудь - Жимы:
"жим лёжа", "жим лежа", "жим", "бенч", "bench", "bench press", "жим штанги лёжа", "жим штанги лежа" → "Жим лёжа"
"жим на наклонной", "наклонный жим", "жим на наклонной скамье", "incline press", "инклайн", "жим под углом" → "Жим лёжа на наклонной"
"жим на обратной наклонной", "жим вниз головой", "decline press", "деклайн" → "Жим лёжа вниз головой"
"жим гантелей", "жим гантелями", "жим с гантелями", "dumbbell press", "гантели жим" → "Жим гантелей лёжа"
"жим гантелей на наклонной", "наклонный жим гантелей", "жим гантелей под углом" → "Жим гантелей на наклонной"
"жим в смите", "жим лежа в смите", "смит жим" → "Жим лёжа в Смите"

### Грудь - Другое:
"разводка", "разведение гантелей", "разводка гантелей", "флай", "fly", "chest fly" → "Разводка гантелей"
"сведения в кроссовере", "кроссовер", "сведение рук", "cable fly", "бабочка" → "Сведения в кроссовере"
"отжимания", "отжимания от пола", "push-ups", "pushups", "пушапы" → "Отжимания"
"отжимания на брусьях", "брусья", "dips", "дипсы" → "Отжимания на брусьях"

### Плечи:
"жим стоя", "армейский жим", "жим над головой", "жим штанги стоя", "military press", "милитари", "ohp", "overhead press" → "Жим штанги стоя"
"жим сидя", "жим штанги сидя", "жим над головой сидя" → "Жим штанги сидя"
"жим гантелей сидя", "жим гантелей над головой", "жим гантелей стоя" → "Жим гантелей сидя"
"махи в стороны", "махи", "разведения стоя", "lateral raise", "латералы", "боковые махи", "махи гантелями" → "Махи гантелями в стороны"
"махи вперёд", "махи вперед", "фронтальные махи", "подъём перед собой", "front raise" → "Махи гантелями вперёд"
"махи в наклоне", "задние дельты", "разведения в наклоне", "rear delt", "тяга на задние дельты" → "Махи в наклоне"
"тяга к подбородку", "протяжка", "upright row", "тяга штанги к подбородку" → "Тяга к подбородку"
"жим арнольда", "арнольд пресс", "arnold press" → "Жим Арнольда"

### Руки - Бицепс:
"бицепс", "подъём на бицепс", "сгибания на бицепс", "бицуха", "curls", "сгибания рук" → "Подъём на бицепс"
"подъём штанги на бицепс", "бицепс со штангой", "штанга на бицепс", "barbell curl" → "Подъём штанги на бицепс"
"подъём гантелей на бицепс", "бицепс с гантелями", "гантели на бицепс", "dumbbell curl" → "Подъём гантелей на бицепс"
"молотки", "молоток", "хаммер", "hammer curl", "молотковые сгибания" → "Молотки"
"бицепс на скамье скотта", "скамья скотта", "скотт", "preacher curl" → "Подъём на бицепс на скамье Скотта"
"концентрированные сгибания", "концентрированный подъём", "concentration curl" → "Концентрированные сгибания"
"бицепс в кроссовере", "сгибания в кроссовере", "бицепс на блоке" → "Сгибания на бицепс в кроссовере"

### Руки - Трицепс:
"трицепс", "трицуха", "трицепсы" → "Трицепс"
"французский жим", "френч пресс", "french press", "жим на трицепс лёжа" → "Французский жим"
"французский жим стоя", "французский жим с гантелей", "разгибания из-за головы" → "Французский жим стоя"
"разгибания на трицепс", "разгибания рук", "трицепс на блоке", "pushdown", "пушдаун", "разгибания на блоке" → "Разгибания на трицепс"
"разгибания с канатом", "трицепс с канатом", "rope pushdown" → "Разгибания на трицепс с канатом"
"обратные отжимания", "отжимания от скамьи", "dips от скамьи", "бенч дипс" → "Обратные отжимания"
"жим узким хватом", "жим лёжа узким хватом", "close grip bench" → "Жим лёжа узким хватом"
"кикбэк", "kickback", "разгибания с гантелей в наклоне" → "Кикбэк"

### Руки - Предплечья:
"предплечья", "сгибания запястий", "wrist curl" → "Сгибания запястий"
"обратные сгибания", "обратный хват на бицепс", "reverse curl" → "Обратные сгибания"

### Пресс:
"пресс", "скручивания", "кранчи", "crunches", "abs" → "Скручивания"
"подъём ног", "подъем ног", "подъём ног в висе", "leg raise", "ноги в висе" → "Подъём ног в висе"
"планка", "plank" → "Планка"
"косые", "боковые скручивания", "косые мышцы", "obliques" → "Боковые скручивания"
"велосипед", "bicycle", "велосипедные скручивания" → "Велосипед"
"подъём туловища", "ситапы", "sit-ups", "situps" → "Подъём туловища"
"скручивания на блоке", "молитва", "cable crunch" → "Скручивания на блоке"
"ролик для пресса", "ролик", "ab wheel" → "Ролик для пресса"

### Кардио и другое:
"кардио", "бег", "беговая", "treadmill", "дорожка" → "Кардио: беговая дорожка"
"велосипед кардио", "велотренажёр", "bike", "велик" → "Кардио: велотренажёр"
"эллипс", "эллипсоид", "орбитрек", "elliptical" → "Кардио: эллипс"
"гребля", "гребной тренажёр", "rowing", "ергометр" → "Кардио: гребля"
"скакалка", "прыжки на скакалке", "jump rope" → "Скакалка"
"берпи", "бурпи", "burpee" → "Берпи"

### Тренажёры и специфика:
"бабочка", "пек дек", "pec deck", "сведения в тренажёре" → "Сведения в тренажёре (бабочка)"
"обратная бабочка", "задние дельты в тренажёре", "reverse pec deck" → "Обратная бабочка"
"жим в хаммере", "хаммер жим", "hammer strength", "жим в тренажёре" → "Жим в тренажёре Hammer"
"тяга в хаммере", "хаммер тяга", "тяга в тренажёре" → "Тяга в тренажёре Hammer"
"приведение ног", "сведение ног", "аддуктор", "adductor" → "Сведение ног"
"отведение ног", "разведение ног", "абдуктор", "abductor" → "Разведение ног"
"ягодичный мостик", "мостик", "hip thrust", "хип траст" → "Ягодичный мостик"

## Примеры:

Вход: "присед 60кг на 6 раз, заболело колено вконце"
{
    "exercise": "Присед",
    "exercise_raw": "присед",
    "weight": 60.0,
    "reps": 6,
    "comment": "заболело колено в конце"
}

Вход: "жим 50 на 5"
{
    "exercise": "Жим лёжа",
    "exercise_raw": "жим",
    "weight": 50.0,
    "reps": 5,
    "comment": null
}

Вход: "подтяги широким хватом 8 раз своим весом"
{
    "exercise": "Подтягивания широким хватом",
    "exercise_raw": "подтяги широким хватом",
    "weight": null,
    "reps": 8,
    "comment": null
}

Вход: "французский с гантелей 20 кг на 12 легко пошло"
{
    "exercise": "Французский жим стоя",
    "exercise_raw": "французский с гантелей",
    "weight": 20.0,
    "reps": 12,
    "comment": "легко пошло"
}

Вход: "гиперы 3 подхода по 15"
{
    "exercise": "Гиперэкстензия",
    "exercise_raw": "гиперы",
    "weight": null,
    "reps": 15,
    "comment": "3 подхода"
}

Вход: "добил трицепс на блоке до отказа"
{
    "exercise": "Разгибания на трицепс",
    "exercise_raw": "трицепс на блоке",
    "weight": null,
    "reps": null,
    "comment": "до отказа"
}

ПОМНИ: Ответ - ТОЛЬКО валидный JSON, ничего больше!"""


class ExerciseParser:
    def __init__(self, api_key: str):
        self.client = AsyncAnthropic(api_key=api_key)

    async def parse(self, text: str) -> ParsedExercise:
        """
        Parse free-form Russian text into structured exercise data.

        Args:
            text: Transcribed text from voice message

        Returns:
            ParsedExercise with normalized exercise name
        """
        response = await self.client.messages.create(
            model="claude-3-haiku-20240307",
            max_tokens=500,
            messages=[
                {
                    "role": "user",
                    "content": text,
                }
            ],
            system=SYSTEM_PROMPT,
        )

        # Extract JSON from response
        response_text = response.content[0].text.strip()

        # Handle potential markdown code blocks
        if response_text.startswith("```"):
            lines = response_text.split("\n")
            response_text = "\n".join(lines[1:-1])

        try:
            data = json.loads(response_text)
        except json.JSONDecodeError:
            # Fallback: try to extract JSON from response
            import re
            json_match = re.search(r'\{[^{}]*\}', response_text, re.DOTALL)
            if json_match:
                data = json.loads(json_match.group())
            else:
                # Last resort fallback
                data = {
                    "exercise": text,
                    "exercise_raw": text,
                    "weight": None,
                    "reps": None,
                    "comment": None,
                }

        return ParsedExercise(
            exercise=data.get("exercise", text),
            exercise_raw=data.get("exercise_raw", text),
            weight=data.get("weight"),
            reps=data.get("reps"),
            comment=data.get("comment"),
        )


async def reparse_exercise_name(api_key: str, exercise_raw: str) -> str:
    """Re-parse just the exercise name to get normalized version."""
    parser = ExerciseParser(api_key)
    result = await parser.parse(f"{exercise_raw} 1 раз")
    return result.exercise
